"use strict";Date.prototype.simpleDate=function(){var a=this.getFullYear(),b=this.getMonth()+1,c=this.getDate();return a+"-"+(1===b.toString().length?"0"+b:b)+"-"+(1===c.toString().length?"0"+c:c)};const gcMaturitychartLocales={en:{options:{title:"Maturity chart"},product:"Harvest Maturity",description:{id:"ID",parcel:"Parcel"},chart:{no_data_msg:"No data available"}},de:{options:{title:"Reife Graph"},product:"Reife",description:{id:"Nr",parcel:"Feld"},chart:{no_data_msg:"Keine Daten verf√ºgbar"}}};Vue.component("gc-maturity-chart",{props:{gcWidgetId:{type:String,default:"maturity-chart1",required:!0},gcMaturityData:{type:Array,default:[]},gcMode:{type:String,default:"line"},gcAvailableOptions:{type:String,default:"title,legend"},gcWidgetCollapsed:{type:Boolean,default:!0},gcLanguage:{type:String,default:"en"},gcSelectedDate:{type:String,default:""},gcYScale:{type:String,default:"fixed"},gcWhiteLabel:{type:Boolean,default:!1},gcZoomDomain:{type:String,default:[]}},template:'<div :id="gcWidgetId" class="gc-maturity-chart">       \n\n              <p class="gc-options-title is-size-6 is-orange" style="cursor: pointer;" \n                v-on:click="toggleMaturitychart"   \n                v-show="this.availableOptions.includes(\'title\')">\n                {{ $t(\'options.title\') }}\n                <i :class="[gcWidgetCollapsed ? \'\': \'is-active\', \'fas\', \'fa-angle-down\', \'fa-sm\']"></i>\n              </p>\n              <div :class="[gcWidgetCollapsed ? \'\': \'is-hidden\']">\n               <div class="is-flex">\n                <div class="is-grey" v-show="this.availableOptions.includes(\'description\')">\n                </div>\n\n                </div>\n                \x3c!-- watermark --\x3e\n                <div :class="[this.gcWhiteLabel ? \'is-hidden\': \'is-inline-block\', \'is-pulled-right\']"\n                  style="opacity: 0.65;">\n                  <span style="vertical-align: top; font-size: 0.7rem;">powered by</span><br>\n                  <img src="img/logo.png" alt="geo|cledian" style="width: 100px; margin: -10px 0;">\n                </div>\n               </div>\n\n                <div :id="\'chartNotice_\'+gcWidgetId" class="content is-hidden"></div>\n\n                <div :id="\'chartSpinner_\'+gcWidgetId" class="chartSpinner maturity-chart-spinner is-hidden"  style="max-height: 50px!important;">\n                  <div class="rect1"></div>\n                  <div class="rect2"></div>\n                  <div class="rect3"></div>\n                  <div class="rect4"></div>\n                  <div class="rect5"></div>\n                </div>\n\n                <div style="position: relative;">\n                  <div :id="\'chart_\'+gcWidgetId" class="gc-maturity-chart">\n                  </div>\n                  <div :id="\'chartlegend_\'+gcWidgetId"></div>\n                </div>\n              </div>\n          </div>\n          \x3c!-- chart --\x3e',data:function(){return{chart:void 0,chartSelectedDate:null,maxDaysOff:7}},computed:{availableOptions:{get:function(){return this.gcAvailableOptions.split(",")}},currentLanguage:{get:function(){return this.gcLanguage}},selectedDate:{get:function(){return this.gcSelectedDate},set:function(value){console.debug("selectedDate - setter: "+value),this.$root.$emit("queryDateChange",value)}}},i18n:{locale:this.currentLanguage,messages:gcMaturitychartLocales},created:function(){console.debug("maturity-chart! - created()");try{this.changeLanguage()}catch(ex){console.error(ex)}},mounted:function(){document.getElementById("chartSpinner_"+this.gcWidgetId).classList.remove("is-hidden"),this.$root.$on("containerSizeChange",this.containerSizeChange),this.chart=bb.generate({bindto:"#chart_"+this.gcWidgetId,data:{x:"x",columns:[],empty:{label:{text:this.$t("chart.no_data_msg")}}},grid:{x:{show:!0},y:{show:!0}},axis:{x:{type:"timeseries",tick:{fit:!1,format:"%e %b %y"}},y:{label:{text:"\n                                          \n\n",position:"outer-top"},max:100,min:0,padding:{top:10,bottom:0}}}}),this.gcParcelId>0&&(this.currentParcelID=this.gcParcelId,this.handleCurrentParcelIDchange())},watch:{gcMaturityData(newValue,oldValue){this.createChartData()},currentLanguage(newValue,oldValue){this.changeLanguage(),this.createChartData()},gcMode(newValue,oldValue){this.createChartData()},gcSelectedDate(newValue,oldValue){if(console.debug("event - gcSelectedDate"),console.log(newValue,oldValue),console.log(this.chartSelectedDate),this.chartSelectedDate!==newValue){{let index=this.getClosestTimeSeriesIndex(this.gcMaturityData,newValue,this.maxDaysOff);index>=0?this.chart.select("maturity",[index],!0):this.chart.unselect("maturity")}console.log(this.chart.selected())}else console.debug("ALREADY selected date found!!")},gcZoomDomain(newValue,oldValue){console.debug("event - gcZoomDomain"),new Date(newValue[0]).getTime()<new Date(newValue[1]).getTime()&&(this.chart.zoom(newValue),this.$root.$emit("zoomDomainChange",newValue))}},methods:{toggleMaturitychart:function(){this.gcWidgetCollapsed=!this.gcWidgetCollapsed},createChartData:function(){console.debug("createChartData()");let columns=[];if(this.gcMaturityData.length>0){let dates=this.gcMaturityData.filter(m=>null!==m.mean).map(m=>m.date),filteredStats=this.gcMaturityData.filter(m=>null!==m.mean).map(m=>this.formatDecimal(m.mean,2));columns[0]=["x"].concat(dates),columns[1]=["maturity"].concat(filteredStats)}document.getElementById("chartSpinner_"+this.gcWidgetId).classList.add("is-hidden"),document.getElementById("chart_"+this.gcWidgetId).classList.remove("is-hidden"),document.getElementById("chartNotice_"+this.gcWidgetId).classList.add("is-hidden"),this.createChart(columns)},createChart:function(data){console.debug(data);let color_options={maturity:"#d7191c"},ys_options={max:"dynamic"==this.gcYScale?void 0:100,min:"dynamic"==this.gcYScale?void 0:0},axis_label=this.$t("product");this.chart=bb.generate({bindto:"#chart_"+this.gcWidgetId,data:{selection:{enabled:!0,multiple:!1,grouped:!1},x:"x",columns:[],names:{maturity:this.$t("product")},empty:{label:{text:this.$t("chart.no_data_msg")}},type:this.gcMode,colors:color_options,onselected:function(e,svgElement,b,c){console.debug("gc-maturity-chart onselected()"),e.x&&(this.chartSelectedDate=e.x.simpleDate(),this.selectedDate=e.x.simpleDate())}.bind(this)},spline:{interpolation:{type:"monotone"}},transition:{duration:300},legend:{show:this.availableOptions.includes("legend")},line:{connectNull:!0},point:{show:!0,focus:{expand:{r:6}},opacity:1,r:function(d){return null==d.value?0:3}},transition:{duration:300},grid:{x:{show:!0},y:{show:!0}},axis:{x:{type:"timeseries",tick:{rotate:60,multiline:!0,fit:!1,format:"%e %b %y"},padding:{right:18144e5,left:18144e5}},y:{label:{text:axis_label,position:"outer-top"},max:ys_options.max,min:ys_options.min,padding:{top:10,bottom:0}}},zoom:{enabled:!0,type:"drag"},tooltip:{grouped:!0,format:{name:function(name,ratio,id,index){return name}}}}),this.chart.load({columns:data,done:function(){setTimeout(function(){this.chart.resize()}.bind(this),100)}.bind(this)})},containerSizeChange(size){console.debug("containerSizeChange - gc-maturity-chart"),this.chart.resize()},changeLanguage(){this.$i18n.locale=this.currentLanguage},getClosestDate:function(arr,queryDate){let i;return console.debug("getClosestDate()"),arr.sort((function(a,b){var distancea,distanceb;return Math.abs(queryDate-a)-Math.abs(queryDate-b)}))[0]},getClosestTimeSeriesIndex:function(timeseries,queryDate,maxDaysOff){console.debug("getClosestTimeSeriesIndex()");const closestDate=this.getClosestDate(timeseries.map(d=>new Date(d.date)),new Date(queryDate));if(void 0!==closestDate){if(Math.abs(new Date(queryDate)-closestDate)<=864e5*maxDaysOff)return console.debug("closest date of given date "+queryDate+" is "+closestDate.simpleDate()+" within "+maxDaysOff+" days"),timeseries.map(d=>d.date).indexOf(closestDate.simpleDate());console.debug("no closest date of given date "+queryDate+" found within "+maxDaysOff+" days")}},removeFromArray:function(arry,value){let index=arry.indexOf(value);return index>-1&&arry.splice(index,1),arry},formatDecimal:function(decimal,numberOfDecimals){var factor=100;return isNaN(parseFloat(decimal))?NaN:(1==numberOfDecimals&&(factor=10),2==numberOfDecimals&&(factor=100),3==numberOfDecimals&&(factor=1e3),4==numberOfDecimals&&(factor=1e4),5==numberOfDecimals&&(factor=1e5),Math.ceil(decimal*factor)/factor)},capitalize:function(s){return"string"!=typeof s?"":s.charAt(0).toUpperCase()+s.slice(1)},isDateValid:function(date_str){return!isNaN(new Date(date_str))},loadJSscript:function(url,callback){let script=document.createElement("script");script.src=gcGetBaseURL()+"/"+url,script.async=!0,console.debug(script.src),document.body.appendChild(script),script.onload=function(){callback()}},showMsg:function(msg){try{document.getElementById("sDate_"+this.gcWidgetId).classList.add("is-hidden")}catch(ex){}try{document.getElementById("desc_"+this.gcWidgetId).classList.add("is-hidden")}catch(ex){}document.getElementById("chartNotice_"+this.gcWidgetId).innerHTML="key is not authorized"===msg?"Sorry, the given API key is not authorized!<br> Please contact <a href='https://www.geocledian.com'>geo|cledian</a> for a valid API key.":"api key validity expired"===msg?"Sorry, the given API key's validity expired!<br> Please contact <a href='https://www.geocledian.com'>geo|cledian</a>for a valid API key.":"Sorry, an error occurred!<br>Please check the console log for more information.",document.getElementById("chartNotice_"+this.gcWidgetId).classList.remove("is-hidden"),document.getElementById("chartSpinner_"+this.gcWidgetId).classList.add("is-hidden")},hideMsg:function(msg){try{document.getElementById("sDate_"+this.gcWidgetId).classList.remove("is-hidden")}catch(ex){}try{document.getElementById("desc_"+this.gcWidgetId).classList.remove("is-hidden")}catch(ex){}document.getElementById("chartNotice_"+this.gcWidgetId).classList.add("is-hidden"),document.getElementById("chart_"+this.gcWidgetId).classList.add("is-hidden"),document.getElementById("chartSpinner_"+this.gcWidgetId).classList.remove("is-hidden")}}});